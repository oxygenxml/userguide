<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="webauthor-concurrent-editing-api">
  <title>Integrating Concurrent Editing</title>
  <prolog>
    <metadata>
      <keywords>
        <indexterm>Enabling shared session</indexterm>
        <indexterm>Enabling concurrent editing</indexterm>
      </keywords>
    </metadata>
  </prolog>
  <body>
    <p id="p_wbt_dgk_54b"><ph keyref="webappProduct"/> provides the <xref
        href="https://www.oxygenxml.com/doc/ug-webauthor/topics/webauthor-concurrent-editing.html"
        format="html" scope="external">ability for teams to edit and review content
        concurrently</xref>. The concurrent editing feature can be enabled either with the built-in
        <uicontrol>Share Editing Session</uicontrol> action or by integrating the concurrent editing
      support in a CMS using the available API. The <uicontrol>Share Editing Session</uicontrol>
      action works by allowing the user to share their editing session by using the
          <uicontrol><image href="../img/wa-share-session-button.png" id="image_kyj_315_rnb"/>Share
        Editing Session</uicontrol> toolbar button and then sending the retrieved URL to other
      collaborators and then all of them can edit and review the same document simultaneously.</p>
  </body>
  <topic id="topic_k2k_qgt_rnb">
    <title>Enabling the Share Editing Session Action</title>
    <body>
      <p id="p_xbt_dgk_54b">To enable the <uicontrol><image
            href="../img/wa-share-session-button.png" id="image_fvg_w15_rnb"/>Share Editing
          Session</uicontrol> action, the following conditions must be met:</p>
      <p id="p_ybt_dgk_54b">
        <ul id="ul_s3b_yk4_snb">
          <li id="li_zbt_dgk_54b">The <uicontrol>Concurrent Editing Plugin</uicontrol> must be
            enabled in the <xref href="webapp-admin-page.dita#webapp-admin-page">Administration
              Page</xref> (it is bundled with the <ph keyref="webappProduct"/> installers and is
            enabled by default).</li>
          <li id="li_act_dgk_54b">The <codeph>sharedSessionCompatible</codeph>
            <xref keyref="jscript_api_workspace_LoadingOptions">loading option</xref> must be set to
              <codeph>true</codeph> by the CMS connector plugin. Note that the built-in connectors
            (for e.g. the Git connector) have this option by default configured.</li>
        </ul>
      </p>
      <p id="p_bct_dgk_54b">For the feature to work correctly, when a concurrent session is active, the CMS connector
        plugin should ensure that:</p>
      <ul id="ul_aq3_jgt_rnb">
        <li id="li_cct_dgk_54b">Any save/commit action is disabled for session guests.</li>
        <li id="li_dct_dgk_54b">Any check-in/check-out actions are disabled for session guests.</li>
        <li id="li_ect_dgk_54b">The document is editable for guests even though they do not have a lock for it.</li>
      </ul>
      <p id="p_fct_dgk_54b">To detect that a user is a <i>guest</i>, you can use the following JavaScript
        code:<codeblock outputclass="language-javascript" id="codeblock_gct_dgk_54b">var mgr = editor.getEditingSupport().getConcurrentEditingManager();    
if (mgr &amp;&amp; !mgr.isCreator()) {      
      ...
} </codeblock></p>
      <note type="other" othertype="Important Notes About Concurrent Editing for Integrators"
        id="note_hct_dgk_54b">
        <ul id="ul_r51_fc5_rnb">
          <li id="li_ict_dgk_54b">Concurrent editing does not work if <ph keyref="webappProduct"/>
            is deployed on multiple servers behind a <xref href="webapp-loadbalancing.dita">load
              balancer</xref>.</li>
          <li id="li_jct_dgk_54b">
            <p id="p_kct_dgk_54b"><ph keyref="webappProduct"/> uses Web Sockets to propagate changes
              in real time between collaborators. If you are using a reverse proxy, some additional
              configuration may be required to enable Web Socket connections to the
                <codeph>./ws</codeph> endpoint of the application.</p>
            <p id="p_lct_dgk_54b">For example, NGINX requires the following configuration for the
                <filepath>/oxygen-xml-web-author/ws</filepath>
              path:<codeblock outputclass="language-javascript" id="codeblock_mct_dgk_54b">location /oxygen-xml-web-author/ws {
  proxy_http_version 1.1;
      
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
  proxy_set_header Host $host;
      
  proxy_pass http://web-author:8080;
}</codeblock></p>
            <p id="p_nct_dgk_54b">As another example, when using Apache HTTP server as a reverse
              proxy, a system administrator needs to enable the following modules:</p>
            <ul id="ul_gp2_zl4_snb">
              <li id="li_oct_dgk_54b">
                <p id="p_pct_dgk_54b"><codeph>rewrite</codeph></p>
              </li>
              <li id="li_qct_dgk_54b">
                <p id="p_rct_dgk_54b"><codeph>proxy_http</codeph></p>
              </li>
              <li id="li_sct_dgk_54b">
                <p id="p_tct_dgk_54b"><codeph>proxy_wstunnel</codeph>
                </p>
              </li>
            </ul>
            <p id="p_uct_dgk_54b">Also, a configuration should be added similar to
              this:<codeblock outputclass="" id="codeblock_vct_dgk_54b">ProxyPass /oxygen-xml-web-author http://&lt;internal-host>:8080/oxygen-xml-web-author
ProxyPassReverse /oxygen-xml-web-author http://&lt;internal-host>:8080/oxygen-xml-web-author

RewriteEngine on
RewriteCond %{​HTTP:Upgrade}​ websocket [NC]
RewriteCond %{​HTTP:Connection}​ upgrade [NC]
RewriteRule ^/oxygen-xml-web-author/?(.*) 
 "ws://&lt;internal-host>:8080/oxygen-xml-web-author/$1" [P,L]</codeblock></p>
            <p>When using the IIS web server as a reverse proxy, you need to configure it according
              to <xref href="WA-websocket.dita">this tutorial</xref>.</p>
          </li>
          <li id="li_g14_hq2_fqb">Some customizations can cause problems if used in situations with
            high activity or a large number of users simultaneously. These possible limitations
              include:<ul id="ul_vyr_mq2_fqb">
              <li id="li_oxj_sb2_tpb">The <codeph>onChange</codeph> property for the <xref
                  href="https://www.oxygenxml.com/doc/ug-editor/topics/combo-box-editor.html"
                  format="html" scope="external">combo box form control</xref> is not supported in
                concurrent editing sessions.</li>
              <li id="li_wyr_mq2_fqb">Inline CSS actions (for example, when used in an
                  <codeph>oxy_button</codeph> form control).</li>
              <li id="li_im1_nq2_fqb">Editable combo boxes on the floating toolbar.</li>
              <li id="li_yc1_4q2_fqb">Quick fixes that come from XML Schema or DTD.</li>
            </ul></li>
        </ul>
      </note>
      <section id="section_mnm_x25_rnb">
        <title>Disabling the Share Editing Session Action</title>
        <p id="p_xct_dgk_54b">To remove the <uicontrol><image
              href="../img/wa-share-session-button.png" id="image_vv2_c25_rnb"/>Share Editing
            Session</uicontrol> action from the toolbar, simply disable the <uicontrol>Concurrent
            Editing Plugin</uicontrol> in the <xref href="webapp-admin-page.dita#webapp-admin-page"
            >Administration Page</xref>.</p>
      </section>
    </body>
  </topic>
  <topic id="topic_n2z_sgt_rnb222">
    <title>CMS-owned Concurrent Editing Sessions</title>
    <body>
      <p id="p_yct_dgk_54b">Aside from using the <uicontrol><image
            href="../img/wa-share-session-button.png" id="image_txt_2f5_rnb"/>Share Editing
          Session</uicontrol> action, a more integrated concurrent editing approach is to have a
        concurrent editing room owned by the CMS. </p>
      <bodydiv>
        <p>A concurrent editing room contains multiple editors, each working on the same document,
          with all changes synchronized in real time. Each editor corresponds to a browser tab and
          is represented by an <codeph>AuthorDocumentModel</codeph> in the API.</p>
      </bodydiv>
      <p>The CMS needs to ensure that there is at most one concurrent editing room for one
        document.</p>
      <p id="p_zct_dgk_54b">The CMS should be responsible for:<ul id="ul_sht_mgt_rnb">
          <li id="li_adt_dgk_54b">Ensuring that aside from the Web Author users, no other users are modifying the file.
            The CMS can use a "service" account to hold the "lock" on the edited file, or to do a
            check-out.</li>
          <li id="li_bdt_dgk_54b">Creating the concurrent editing room.</li>
          <li id="li_cdt_dgk_54b">Adding new editors in the room.</li>
          <li id="li_ddt_dgk_54b">Specifying the Save Strategy.</li>
          <li id="li_edt_dgk_54b">Closing the room.</li>
        </ul></p>
      <section id="section_evc_zgt_rnb">
        <title>Creating a Concurrent Editing Room</title>
        <p>When an user opens a document in an editor, the CMS needs to create a concurrent editing
          room for that document if one is not already created.</p>
        <p id="p_fdt_dgk_54b">The recommended way for a CMS to create a concurrent editing room is
          by using the Java API:</p>
        <codeblock outputclass="language-javascript" id="codeblock_jdt_dgk_54b">import ro.sync.ecss.extensions.api.webapp.ce.RoomsManager;

String roomId = RoomsManager.INSTANCE.createRoomFromDocument(authorDocumentModel) </codeblock>
        <p id="p_kdt_dgk_54b">This can be called in the
            <codeph>ro.sync.ecss.extensions.api.webapp.access.WebappEditingSessionLifecycleListener.editingSessionStarted()</codeph>
          listener. </p>
        <p>Note that the <codeph>roomId</codeph> is automatically stored in the editing context and
          it can be obtained when needed by calling: <codeph>String roomId =
            authorDocumentModel.getAuthorAccess().getEditorAccess().getEditingContext(),getAttribute(Room.ROOM_ID_ATTRIBUTE)</codeph>.</p>
      </section>
      <section id="section_nzw_pkh_2fc">
        <title>Adding New Editors in a Room</title>
        <p>When a user tries to open a document in an editor that the CMS already created a room
          for, it can link the editor to the existing room by using the
            <codeph>ro.sync.ecss.extensions.api.webapp.access.WebappEditingSessionLifecycleListener.editingSessionAboutToBeStarted()</codeph>
          listener. In the implementation of this listener, the ID of the existing room has to be
          added to the <codeph>sessionAttributes</codeph> map using the
            <codeph>ro.sync.ecss.extensions.api.webapp.ce.Room.ROOM_ID_ATTRIBUTE</codeph> key.</p>
      </section>
      <section id="section_jkr_4ht_rnb">
        <title>Saving a Concurrent Editing Session</title>
        <p>When saving a concurrently edited document, the application uses a <term>save
            strategy</term> that can be specified when creating the room by calling
            <codeph>ro.sync.ecss.extensions.api.webapp.ce.RoomFactory.createRoom(AuthorDocumentModel,
            SaveStrategy)</codeph>.</p>
        <p>The save strategy specifies how the changes are grouped when writing the changed document
          to the CMS. For example, if multiple users made changes to the document opened in the room
          since the last save, the save strategy can choose to save the final version to the CMS or
          to save intermediate versions, with every version containing changes from a single
          editor.</p>
        <p>There are two base classes to be extended:<ol id="ol_jt4_v2z_ypb">
            <li><codeph>ro.sync.ecss.extensions.api.webapp.ce.GroupChangesForSinglePeerStrategy</codeph>
              - It facilitates tracking precise authorship of changes, as each written revision
              contains changes by only one author.<note id="note_tg1_1s1_zpb">The
                  <codeph>URLConnection openConnection(URL documentUrl, PeerContext author)</codeph>
                method's <codeph>author</codeph> parameter can be used to determine the user that
                authored the version of the file that is going to be written in the returned
                  <codeph>URLConnection</codeph>.</note></li>
            <li><codeph>ro.sync.ecss.extensions.api.webapp.ce.GroupChangesForMultiplePeersStrategy</codeph>
              - It facilitates a minimum number of writes to the file server per save.<note
                id="note_s3p_cs1_zpb">The <codeph>URLConnection openConnection(URL documentUrl,
                  PeerContext committer, List&lt;PeerContext> authors)</codeph> method has two
                  parameters:<ul id="ul_mpg_knh_2fc">
                  <li><codeph>committer</codeph> - It can be used to identify the user that
                    triggered the save.</li>
                  <li><codeph>authors</codeph> -  It can be used to identify the users that authored
                    the version of the file that is going to be written in the returned
                      <codeph>URLConnection</codeph>.</li>
                </ul></note></li>
          </ol></p>
      </section>
      <section id="section_anj_sht_rnb">
        <title>Closing the Room</title>
        <p id="p_ydt_dgk_54b">A programmatically created room is not closed automatically when the
          last user leaves or closes the browser tab. The room should be closed explicitly using
            <codeph>Room.close()</codeph> when all the users have left and all the changes are
          saved. To identify when a room becomes empty, you can use
            <codeph>WebappEditingSessionLifecycleListener.editingSessionStarted</codeph> and
            <codeph>WebappEditingSessionLifecycleListener.editingSessionClosed</codeph>.</p>
        <p>The <codeph>WebappEditingSessionLifecycleListener.editingSessionStarted</codeph> is
          called each time a tab with a Web Author editor is opened.</p>
        <p>The <codeph>WebappEditingSessionLifecycleListener.editingSessionClosed</codeph> is called
          when the editing session closes. This happens in the following cases:</p>
        <ol id="ol_l4w_1pg_2fc">
          <li>When the user closes the tab or browser cleanly.</li>
          <li>If the tab or browser is not closed cleanly:<ol id="ol_olv_ppg_2fc">
              <li>When the user's session expires (by default, this happens after 12 hours).</li>
              <li>When using the <xref href="customizing-options.dita" format="dita"
                  >always.send.keepalive</xref> option and the timeout is reached.</li>
            </ol></li>
        </ol>
        <p>To access the room object, you can use
            <codeph>RoomsManager.INSTANCE.getRoom(roomId)</codeph>.</p>
      </section>
    </body>
    <related-links>
        <link format="html"
          href="https://github.com/oxygenxml/web-author-sample-plugins/tree/master/web-author-rooms-manager-plugin"
          scope="external">
          <linktext>Open Source Sample Room Manager Plugin</linktext>
        </link>
        <link
          href="https://github.com/oxygenxml/web-author-sample-plugins/tree/master/web-author-rooms-manager-plugin"
          format="html" scope="external">
          <linktext>Open Source Sample Plugin for Saving Content in a Concurrent Editing
            Room</linktext>
        </link>
    </related-links>
  </topic>
</topic>
